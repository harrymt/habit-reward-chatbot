#!/usr/bin/env node

'use strict';

console.log('Sending reminders..');

// Send to logging service
const request = require('request-promise');

const options = {
  method: 'GET',
  uri: 'https://nosnch.in/9e699ea11f'
};
request(options)
  .then(response => {
    console.log(response);
    sendReminders();
  })
  .catch(err => {
    console.log(err);
    sendReminders();
  });

/**
 * Actually send the reminders
 */
function sendReminders() {
  const Bot = require('../bot');

  let quickReplyActions = [
    'Completed Habit',
    'Not Today',
    'Snooze'
  ];

  // Decide what period of the day it is
  const dayHour = (new Date()).getUTCHours();
  let timeOfDay = '';

  if (dayHour === Bot.time.morning) {
    timeOfDay = 'MORNING';
  } else if (dayHour === Bot.time.afternoon) {
    timeOfDay = 'AFTERNOON';
  } else if (dayHour === Bot.time.evening) {
    timeOfDay = 'EVENING';
  } else if (dayHour === Bot.time.night) {
    timeOfDay = 'NIGHT';
    // Remove snooze if its the night
    quickReplyActions = [
      'Completed Habit',
      'Not Today'
    ];
  } else {
    // Not time todo things
    console.log('Not time to send reminders... time: ' + dayHour + ' date: ' + (new Date()).toUTCString());
    process.exit();
  }

  if (process.env.NODE_ENV !== 'production') {
    // Load the .env file, that sets process.env.
    require('dotenv').load();
  }

  const FB = require('../connectors/facebook');

  // Debug Logging!
  console.log('We got a reminder at time: ' + timeOfDay);

  // Get all users based on time
  // Setup online database, airtable
  const base = require('airtable').base('app5u2vOBmkjxLp4M');

  let i = 0;
  base('Users').select({
    filterByFormula: '({reminderTime} = "' + timeOfDay + '")'
  }).eachPage(function page(records, fetchNextPage) {

    records.forEach(record => {
      console.log('Found user ' + record.get('fbid'));

      if (record.get('habit') === undefined) {
        console.log('User hasn\'t told us their habit');
      } else {
        FB.newMessage(record.get('fbid'),
          Bot.createQuickReply(
            'Hey, have you completed your daily ' + Bot.convertToFriendlyName(record.get('habit')) + '?',
            quickReplyActions
          ),
          (msg, data) => {
            i++;
            if (data.error) {
              console.log('Error sending new fb message');
              console.log(msg); // Log received info
              console.log(data); // Log recieved info
              console.log('Looking for next page');
            }
            fetchNextPage();
          }
        );
      }
    });
  }, function done(err) {
    if (err) {
      console.error(err);
      throw new Error(err);
    }
    console.log('Sent ' + timeOfDay + ' reminders to ' + i + ' users.');
    process.exit();
  });
}
